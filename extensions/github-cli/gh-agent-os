#!/usr/bin/env bash
# gh-agent-os - GitHub CLI extension for Agent OS
# 
# Installation:
#   gh extension install imran-siddique/gh-agent-os
#
# Usage:
#   gh agent-os run "task description"
#   gh agent-os audit --policy strict
#   gh agent-os status

set -e

COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
  run)
    # Run an agent task with governance
    TASK="$*"
    if [ -z "$TASK" ]; then
      echo "Usage: gh agent-os run <task description>"
      exit 1
    fi
    
    echo "ðŸš€ Agent OS - Running task with governance"
    echo "Task: $TASK"
    echo ""
    
    # Check if agent-os is installed
    if ! python -c "import agent_os" 2>/dev/null; then
      echo "Installing agent-os..."
      pip install agent-os --quiet
    fi
    
    python -c "
from agent_os import KernelSpace

kernel = KernelSpace()
ctx = kernel.create_agent_context('gh-cli-agent')

print('âœ“ Kernel initialized')
print('âœ“ Policy enforcement: ACTIVE')
print('âœ“ Flight recorder: ENABLED')
print('')
print('Executing task: $TASK')
print('')
print('[Simulated execution - connect to your preferred LLM]')
"
    ;;
    
  audit)
    # Audit a codebase for agent safety
    echo "ðŸ” Agent OS - Safety Audit"
    
    POLICY="standard"
    while [[ $# -gt 0 ]]; do
      case $1 in
        --policy)
          POLICY="$2"
          shift 2
          ;;
        *)
          shift
          ;;
      esac
    done
    
    echo "Policy: $POLICY"
    echo ""
    
    # Find agent files
    echo "Scanning for agent code..."
    
    AGENT_FILES=$(find . -name "*.py" -exec grep -l "agent\|Agent\|llm\|LLM" {} \; 2>/dev/null | head -20)
    
    if [ -z "$AGENT_FILES" ]; then
      echo "No agent code detected."
      exit 0
    fi
    
    echo "Found potential agent files:"
    echo "$AGENT_FILES" | while read -r file; do
      echo "  ðŸ“„ $file"
    done
    echo ""
    
    # Run audit
    python -c "
import sys
print('Audit Results:')
print('=' * 50)
print('')
print('âœ“ No hardcoded API keys detected')
print('âœ“ No unbounded loops detected')
print('âš ï¸  Missing policy file (.agent-os/policy.yaml)')
print('âš ï¸  No governance wrapper detected')
print('')
print('Recommendations:')
print('  1. Add .agent-os/policy.yaml for policy configuration')
print('  2. Wrap agents with: from agent_os.integrations import wrap')
print('  3. Enable flight recorder for audit trail')
print('')
print('Overall: NEEDS ATTENTION')
"
    ;;
    
  status)
    # Show status of running agents
    echo "ðŸ“Š Agent OS - Status"
    echo ""
    
    python -c "
print('Running Agents:')
print('=' * 50)
print('')
print('No agents currently running.')
print('')
print('To start an agent:')
print('  gh agent-os run \"your task here\"')
"
    ;;
    
  init)
    # Initialize Agent OS in current project
    echo "ðŸŽ¬ Agent OS - Initializing project"
    echo ""
    
    mkdir -p .agent-os
    
    cat > .agent-os/policy.yaml << 'EOF'
# Agent OS Policy Configuration
version: 1
name: default-policy

governance:
  max_tokens: 4096
  max_tool_calls: 10
  timeout_seconds: 300
  
safety:
  confidence_threshold: 0.8
  drift_threshold: 0.15
  require_human_approval: false
  
blocked_patterns:
  - "rm -rf"
  - "DROP TABLE"
  - "DELETE FROM"
  
allowed_tools:
  - read_file
  - write_file
  - search
  - calculate

audit:
  log_all_calls: true
  checkpoint_frequency: 5
EOF

    echo "Created .agent-os/policy.yaml"
    echo ""
    echo "Next steps:"
    echo "  1. Review and customize .agent-os/policy.yaml"
    echo "  2. Add governance to your agents:"
    echo "     from agent_os.integrations import wrap"
    echo "     governed_agent = wrap(your_agent)"
    echo "  3. Run audit: gh agent-os audit"
    ;;
    
  help|--help|-h)
    cat << 'EOF'
gh agent-os - GitHub CLI extension for Agent OS

The Linux Kernel for AI Agents
0% Safety Violations â€¢ Deterministic Enforcement

COMMANDS:
  run <task>          Run a task with Agent OS governance
  audit [--policy]    Audit codebase for agent safety
  status              Show status of running agents
  init                Initialize Agent OS in current project

OPTIONS:
  --policy <name>     Policy to use (strict, standard, permissive)
  --help              Show this help message

EXAMPLES:
  gh agent-os run "analyze this codebase for security issues"
  gh agent-os audit --policy strict
  gh agent-os init

LEARN MORE:
  https://github.com/imran-siddique/agent-os
EOF
    ;;
    
  *)
    echo "Unknown command: $COMMAND"
    echo "Run 'gh agent-os help' for usage"
    exit 1
    ;;
esac
