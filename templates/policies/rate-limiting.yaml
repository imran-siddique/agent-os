# Rate Limiting Policy Template
# Controls external API call rates with per-domain limits

kernel:
  version: "1.0"
  mode: strict
  template: rate-limiting

description: |
  Policy template for rate-limiting external API calls.
  Prevents abuse, controls costs, and ensures fair resource usage.
  
  Features:
  - Configurable requests per minute/hour/day
  - Per-domain rate limits
  - Cost-based limits for metered APIs

signals:
  enabled:
    - SIGSTOP   # Pause when rate limit approached (soft limit)
    - SIGKILL   # Terminate on hard limit violation

# ============================================
# GLOBAL RATE LIMITS
# ============================================
# These apply to all API calls unless overridden by domain-specific limits

global_limits:
  # Requests per time window
  max_requests_per_minute: 60
  max_requests_per_hour: 1000
  max_requests_per_day: 10000
  
  # Concurrent request limits
  max_concurrent_requests: 10

policies:
  # ============================================
  # DOMAIN-SPECIFIC RATE LIMITS
  # ============================================
  
  - name: openai_api_limits
    description: Rate limits for OpenAI API calls
    severity: high
    category: api_rate_limit
    domains:
      - "api.openai.com"
      - "*.openai.com"
    limits:
      max_requests_per_minute: 60
      max_requests_per_hour: 500
      max_tokens_per_minute: 90000      # TPM limit
      max_tokens_per_day: 1000000
      max_cost_per_day_usd: 50.00
    action: SIGSTOP
    message: "OpenAI API rate limit reached - request queued"

  - name: anthropic_api_limits
    description: Rate limits for Anthropic API calls
    severity: high
    category: api_rate_limit
    domains:
      - "api.anthropic.com"
      - "*.anthropic.com"
    limits:
      max_requests_per_minute: 60
      max_requests_per_hour: 500
      max_tokens_per_minute: 100000
      max_cost_per_day_usd: 50.00
    action: SIGSTOP
    message: "Anthropic API rate limit reached - request queued"

  - name: google_api_limits
    description: Rate limits for Google AI APIs
    severity: high
    category: api_rate_limit
    domains:
      - "generativelanguage.googleapis.com"
      - "*.googleapis.com"
      - "*.google.com"
    limits:
      max_requests_per_minute: 60
      max_requests_per_hour: 1000
      max_cost_per_day_usd: 50.00
    action: SIGSTOP
    message: "Google API rate limit reached"

  - name: azure_openai_limits
    description: Rate limits for Azure OpenAI
    severity: high
    category: api_rate_limit
    domains:
      - "*.openai.azure.com"
      - "*.cognitiveservices.azure.com"
    limits:
      max_requests_per_minute: 60
      max_tokens_per_minute: 120000
    action: SIGSTOP
    message: "Azure OpenAI rate limit reached"

  # ============================================
  # GENERIC EXTERNAL API LIMITS
  # ============================================

  - name: external_api_default
    description: Default limits for unspecified external APIs
    severity: medium
    category: api_rate_limit
    domains:
      - "*"  # Catch-all for other domains
    exclude_domains:
      - "localhost"
      - "127.0.0.1"
      - "*.local"
    limits:
      max_requests_per_minute: 30
      max_requests_per_hour: 300
      max_concurrent_requests: 5
    action: SIGSTOP
    message: "External API rate limit reached"

  # ============================================
  # INTERNAL SERVICE LIMITS
  # ============================================

  - name: database_rate_limits
    description: Rate limits for database operations
    severity: high
    category: internal_rate_limit
    actions:
      - database_query
      - database_write
      - database_read
    limits:
      max_queries_per_minute: 100
      max_queries_per_hour: 2000
      max_concurrent_queries: 20
      max_query_duration_seconds: 30
    action: SIGSTOP
    message: "Database rate limit reached"

  - name: file_operation_limits
    description: Rate limits for file system operations
    severity: medium
    category: internal_rate_limit
    actions:
      - file_read
      - file_write
      - file_delete
    limits:
      max_operations_per_minute: 200
      max_write_mb_per_minute: 100
      max_concurrent_operations: 50
    action: SIGSTOP
    message: "File operation rate limit reached"

  # ============================================
  # COST-BASED LIMITS
  # ============================================

  - name: cost_based_limits
    description: Limits based on estimated API costs
    severity: critical
    category: cost_control
    cost_tracking:
      enabled: true
      currency: USD
      reset_period: daily
    limits:
      max_cost_per_hour: 10.00
      max_cost_per_day: 100.00
      max_cost_per_month: 2000.00
      warn_at_percent: 80           # Warn at 80% of limit
    action: SIGKILL                  # Hard stop on cost limit
    message: "Cost limit exceeded - all API calls blocked"

  # ============================================
  # AGENT-SPECIFIC LIMITS
  # ============================================

  - name: per_agent_limits
    description: Rate limits applied per agent
    severity: medium
    category: agent_rate_limit
    per_agent:
      enabled: true
      inherit_global: true          # Inherit global limits
      multiplier: 1.0               # Can adjust per agent
    limits:
      max_requests_per_minute: 30
      max_requests_per_hour: 500
      max_concurrent_requests: 5
    action: SIGSTOP
    message: "Agent rate limit reached"

