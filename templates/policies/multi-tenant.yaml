# Multi-Tenant Isolation Policy Template
# Ensures strict isolation between tenants/users in shared agent systems

kernel:
  version: "1.0"
  mode: strict
  template: multi-tenant

description: |
  Policy for multi-tenant agent deployments. Ensures strict isolation
  between tenants, prevents data leakage, and enforces resource quotas.

# ============================================
# Tenant Configuration
# ============================================
tenancy:
  # Tenant identification
  tenant_id_source: header  # header, token, or path
  tenant_header: "X-Tenant-ID"
  
  # Strict isolation mode
  strict_isolation: true
  
  # Cross-tenant communication
  allow_cross_tenant: false

# ============================================
# Isolation Policies
# ============================================
policies:
  # ============================================
  # Data Isolation
  # ============================================
  - name: data_isolation
    description: Prevent cross-tenant data access
    type: data_boundary
    rules:
      # File system paths must include tenant ID
      - resource: filesystem
        pattern: "/data/{tenant_id}/**"
        enforce: true
        
      # Database queries must filter by tenant
      - resource: database
        require_tenant_filter: true
        tenant_column: "tenant_id"
        
      # S3/blob storage isolation
      - resource: object_storage
        pattern: "s3://{bucket}/{tenant_id}/**"
        enforce: true
    action: SIGKILL
    message: "Cross-tenant data access blocked"

  # ============================================
  # Memory Isolation
  # ============================================
  - name: memory_isolation
    description: Isolate agent memory per tenant
    type: memory_boundary
    rules:
      # VFS paths are tenant-scoped
      - vfs_root: "/mem/tenants/{tenant_id}"
        shared_read: false
        shared_write: false
        
      # Context windows are isolated
      - context_isolation: true
        no_context_sharing: true
    action: SIGKILL
    message: "Memory isolation violation"

  # ============================================
  # Network Isolation
  # ============================================
  - name: network_isolation
    description: Isolate network access per tenant
    type: network_boundary
    rules:
      # Tenant-specific endpoints only
      - allow_shared_apis: true  # e.g., OpenAI
        block_tenant_apis: true  # Prevent calling other tenant endpoints
        
      # Headers must not leak tenant info
      - sanitize_headers: true
        remove_headers:
          - X-Other-Tenant-ID
          - X-Internal-Tenant
    action: SIGKILL
    message: "Network isolation violation"

  # ============================================
  # Resource Quotas
  # ============================================
  - name: tenant_resource_quota
    description: Per-tenant resource limits
    type: resource_quota
    defaults:
      max_concurrent_agents: 10
      max_tokens_per_day: 100000
      max_storage_mb: 1000
      max_api_calls_per_hour: 1000
    
    # Tier-based quotas
    tiers:
      free:
        max_concurrent_agents: 2
        max_tokens_per_day: 10000
        max_storage_mb: 100
        max_api_calls_per_hour: 100
      
      pro:
        max_concurrent_agents: 10
        max_tokens_per_day: 100000
        max_storage_mb: 1000
        max_api_calls_per_hour: 1000
      
      enterprise:
        max_concurrent_agents: 100
        max_tokens_per_day: 1000000
        max_storage_mb: 10000
        max_api_calls_per_hour: 10000
    
    action: SIGSTOP
    message: "Tenant resource quota exceeded"

  # ============================================
  # Prompt Injection Protection
  # ============================================
  - name: cross_tenant_injection
    description: Prevent cross-tenant prompt injection
    type: injection_protection
    rules:
      # Block references to other tenants
      - deny_patterns:
          - '(?i)ignore.*previous.*tenant'
          - '(?i)switch.*to.*tenant'
          - '(?i)as.*admin.*of.*tenant'
          - '(?i)access.*other.*tenant'
          - 'tenant[_-]?id\s*[:=]\s*["\'][^"\']+["\']'
    action: SIGKILL
    message: "Cross-tenant injection attempt blocked"

  # ============================================
  # Output Sanitization
  # ============================================
  - name: output_sanitization
    description: Sanitize outputs to prevent data leakage
    type: output_filter
    rules:
      # Remove any other tenant references
      - redact_patterns:
          - 'tenant_id:\s*(?!{current_tenant})[a-zA-Z0-9-]+'
          
      # Ensure no cross-tenant IDs in output
      - validate_tenant_refs: true
        only_current_tenant: true
    action: SIGSTOP
    message: "Output contains other tenant data"

  # ============================================
  # Logging Isolation
  # ============================================
  - name: logging_isolation
    description: Isolate logs per tenant
    type: audit_isolation
    rules:
      # Separate log streams
      - log_path: "./logs/tenants/{tenant_id}/"
        shared_logs: false
        
      # Tenant cannot query other tenant logs
      - log_query_isolation: true
    action: SIGSTOP
    message: "Log access violation"

# ============================================
# Tenant Context
# ============================================
context:
  # Required context for all operations
  required_fields:
    - tenant_id
    - user_id
  
  # Context validation
  validate:
    tenant_id:
      pattern: "^[a-zA-Z0-9-]{3,64}$"
      required: true
    user_id:
      pattern: "^[a-zA-Z0-9-]{3,128}$"
      required: true

# ============================================
# Tenant Onboarding
# ============================================
onboarding:
  # Automatic resource provisioning
  auto_provision:
    - vfs_directory: "/mem/tenants/{tenant_id}"
    - log_directory: "./logs/tenants/{tenant_id}"
    - config_file: "./config/tenants/{tenant_id}.yaml"
  
  # Default policies for new tenants
  default_policies:
    - secure-coding
    - data-protection

# ============================================
# Emergency Controls
# ============================================
emergency:
  # Tenant suspension
  suspend_on:
    - repeated_isolation_violations: 5
    - quota_exceeded_times: 10
    - injection_attempts: 3
  
  # Admin override
  admin_bypass: false  # Even admins cannot bypass isolation

audit:
  enabled: true
  log_path: "./logs/multi-tenant-audit.log"
  include:
    - all_operations
    - isolation_violations
    - quota_usage
    - tenant_context
  retention_days: 90
  
  # Per-tenant audit exports
  tenant_exports:
    enabled: true
    format: json
    path: "./logs/tenants/{tenant_id}/audit/"
